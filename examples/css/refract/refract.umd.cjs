(function(p,d){typeof exports=="object"&&typeof module<"u"?d(exports):typeof define=="function"&&define.amd?define(["exports"],d):(p=typeof globalThis<"u"?globalThis:p||self,d(p.Refract={}))})(this,function(p){"use strict";let d=null,w=new WeakMap;function ce(e){d=e}function ae(){d=null}function Se(e){if(d)if(w.has(d)){const t=w.get(d);if(t.cleanup)throw new Error("A Functional Component can only have one cleanup function");t.cleanup=e}else w.set(d,{signals:new Set,cleanup:e,effects:new Set})}function fe(e){if(d)if(w.has(d))w.get(d).effects.add(e);else{const t=new Set;t.add(e),w.set(d,{signals:new Set,cleanup:null,effects:t})}}function $(e){if(d)if(w.has(d))w.get(d).signals.add(e);else{const t=new Set;t.add(e),w.set(d,{signals:t,cleanup:null,effects:new Set})}}function Fe(e,t){const n=w.get(e);if(n){n.cleanup&&n.cleanup(),n.cleanup=null;for(const r of n.effects){if(r.__signals&&Array.isArray(r.__signals))for(const o of r.__signals)o.removeDep(r);delete r.__signals}n.signals.forEach(r=>r.clearDeps()),n.signals.clear()}w.delete(e)}function P(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)&&Object.prototype.toString.call(e)==="[object Object]"}function k(e){return["boolean","string","number","undefined"].includes(typeof e)||e===null||e instanceof Error}function q(e){return Object.entries(e).map(([t,n])=>`${t.replace(/([A-Z])/g,"-$1").toLowerCase()}: ${n};`).join(" ")}function J(e){const t={};for(const[n,r]of Object.entries(e)){if(typeof r=="object"&&r!==null){console.warn(`Nested styles not allowed for ${n}`);continue}r==null||r===!1||r===""||(t[n]=r)}return t}function Y(e){return P(e)||typeof e=="string"}let y=null,h=null;function Z(e){y.__signals?y.__signals.push(e):y.__signals=[e]}function Q(e){h.__signals?h.__signals.push(e):h.__signals=[e]}function ke(e){var n;if(typeof e!="function")throw new Error("reactive takes a render function as the argument");y=e;const t=e();if(y=null,!k(t)&&P(t)&&!t.type&&!t.props&&!((n=t.props)!=null&&n.children))throw new Error("Reactive value must be primitive or functional component, got: "+typeof t);return t}function _e(e){if(typeof e!="function")throw new Error("reactive takes a render function as the argument");y=e;const t=e();return y=null,t}function Ae(e){if(typeof e!="function")throw new Error("createEffect takes a effect function as the argument");h=e,fe(e);const t=e();typeof t=="function"&&Ie(t),h=null}function Te(e){if(typeof e!="function")throw new Error("computed takes a function as the argument");h=()=>{n.value=e()},fe(h);const t=e(),n=C(t);return h=null,n}function Me(e){if(typeof e!="function")throw new Error("createPromise takes a function as the argument");const t=e();if(!(t instanceof Promise))throw new Error("createPromise takes a function that returns a promise");const n=C({status:"pending",data:null,error:null});return t.then(r=>{n.value.data=r,n.value.status="resolved"}).catch(r=>{n.value.error=r,n.value.status="rejected"}),n}class V{constructor(t){this.current=t}}function Le(){return new V(null)}const ue=["concat","every","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","map","reduce","reduceRight","slice","some","toLocaleString","toString"];class N{constructor(t){this.isNotified=!1,this._val=t,this.deps=new Set}notify(){this.isNotified||(this.isNotified=!0,this.deps.forEach(t=>De(()=>(this.isNotified=!1,t))))}removeDep(t){this.deps.delete(t)}clearDeps(){this.deps.clear()}}class Pe extends N{constructor(t){if(!k(t))throw new Error("Invalid type for PrimitiveSignal. Valid types: [boolean, string, number, undefined, null]");super(t)}get value(){return h&&(this.deps.add(h),Q(this)),y&&(this.deps.add(y),Z(this)),this._val}set value(t){if(!k(t))throw new Error("Invalid type for PrimitiveSignal. Valid types: [boolean, string, number, undefined, null]");t!==this._val&&(this._val=t,this.notify())}}class Ne extends N{constructor(t){if(!Array.isArray(t))throw new Error("Invalid type for ArraySignal; value must be an array");super(t),this._val=this.createProxy(t)}createProxy(t){return new Proxy(t,{get:(n,r)=>{const o=n[r];return typeof o=="function"?(...i)=>{const s=o.apply(n,i);return ue.includes(String(r))||this.notify(),s}:o},set:(n,r,o)=>(n[r]=o,this.notify(),!0)})}get value(){return h&&(this.deps.add(h),Q(this)),y&&(this.deps.add(y),Z(this)),this._val}set value(t){if(!Array.isArray(t))throw new Error("Invalid type for ArraySignal; value must be an array");t!==this._val&&(this._val=this.createProxy(t),this.notify())}}class Ce extends N{constructor(t){if(!P(t))throw new Error("Invalid type for ObjectSignal; value must be a plain object");super(t),this._val=this.createProxy(t)}createInternalArrayProxy(t){return new Proxy(t,{get:(n,r)=>{const o=n[r];return typeof o=="function"?(...i)=>{const s=o.apply(n,i);return ue.includes(String(r))||this.notify(),s}:o},set:(n,r,o)=>(n[r]=o,this.notify(),!0)})}createProxy(t){return new Proxy(t,{get:(n,r)=>{const o=n[r];return Array.isArray(o)?(n[r]=this.createInternalArrayProxy(o),n[r]):o},set:(n,r,o)=>typeof o=="function"?!1:(typeof o=="object"&&o!==null&&(o=this.createProxy(o)),o===n[r]||(n[r]=o,this.notify()),!0),deleteProperty:(n,r)=>{const o=delete n[r];return this.notify(),o}})}get value(){return h&&(this.deps.add(h),Q(this)),y&&(this.deps.add(y),Z(this)),this._val}set value(t){if(!P(t))throw new Error("Invalid type for ObjectSignal; value must be a plain object");t!==this._val&&(this._val=this.createProxy(t),this.notify())}}function C(e){if(typeof e=="function")throw new Error("Functions cannot be used as signal value");if(typeof e=="object"&&e!==null)if(Array.isArray(e)){const t=new Ne(e);return $(t),t}else if(P(e)){const t=new Ce(e);return $(t),t}else throw new Error("Invalid type for signal initialization: "+typeof e);else if(k(e)){const t=new Pe(e);return $(t),t}else throw new Error("Invalid type for signal initialization: "+typeof e)}const S=Symbol("FRAGMENT");function B(e,t,...n){if(e==="FRAGMENT"){const r=R(n);return r[S]=!0,r}return{type:e,props:{...t,children:R(n)}}}function R(e){return e.map(t=>{if(typeof t=="object"){if(Array.isArray(t))return R(t);if(t===null)return b("");if(!t.type||!t.props)throw new Error("Invalid type for a dom node, found "+t);return t}else if(typeof t=="function"){const n=ke(t);if(k(n))return v("TEXT_CHILD",{nodeValue:n!=null&&n!==!1?String(n):"",children:[]},t);if(Array.isArray(n)){const r=n[S];return v("FRAGMENT",{children:r?n:R(n)},t)}else if(!n.type||!n.props)throw new Error("Invalid type for a dom node, found "+n);return v(n.type,n.props,t)}else return b(t)}).flat()}function b(e){return{type:"TEXT_CHILD",props:{nodeValue:e!=null&&e!==!1?String(e):"",children:[]}}}function v(e,t,n){return{type:e,renderFunction:n,props:t}}function Re(e){return e!=="children"&&e!=="key"&&e!=="ref"}function de(e){const t=e.type==="TEXT_CHILD"?document.createTextNode(""):document.createElement(e.type);return e.props&&(e.props.ref&&e.props.ref instanceof V&&t instanceof HTMLElement&&(e.props.ref.current=t),Object.keys(e.props).filter(Re).forEach(n=>{if(n.startsWith("on")&&typeof e.props[n]=="function")t.addEventListener(n.slice(2).toLowerCase(),e.props[n]);else if(typeof e.props[n]=="function"&&!n.startsWith("on")){const r=e.props[n];r.__propName=n;const o=_e(r);if(o==null||o===!1)return;if(n==="style"&&typeof o!="string"&&t instanceof HTMLElement){if(!Y(o))throw new Error("Style attribute must be a plain object or a string");const i=J(o);t.setAttribute("style",q(i))}else t instanceof HTMLElement&&(n in t||n.startsWith("data-"))?t.setAttribute(n==="className"?"class":n,String(o)):t[n]=String(o);r.__signals&&He(r,t)}else{if(e.props[n]===null||e.props[n]===void 0||e.props[n]===!1)return;if(n==="style"&&typeof e.props[n]!="string"&&t instanceof HTMLElement){const r=e.props[n];if(!Y(r))throw new Error("Style attribute must be a plain object or a string");const o=J(r);t.setAttribute("style",q(o))}else t instanceof HTMLElement&&(n in t||n.startsWith("data-"))?t.setAttribute(n==="className"?"class":n,String(e.props[n])):t[n]=String(e.props[n])}})),t}function Oe(e,t,n){if(!(n==null||n===!1||e==="key"))if(e==="style"&&typeof n!="string"&&t instanceof HTMLElement){if(!Y(n))throw new Error("Style attribute must be a plain object or a string");const r=J(n);t.setAttribute("style",q(r))}else t instanceof HTMLElement&&(e in t||e.startsWith("data-"))?(e==="className"&&(e="class"),t.setAttribute(e,String(n))):t[e]=String(n)}let x=!1;const ee=new Set,te=new Set,D=new WeakMap,G=new WeakMap,H=[];function Ie(e){H.push(e)}function De(e){ee.add(e),x||(x=!0,queueMicrotask(()=>{H.forEach(t=>t()),H.length=0,ee.forEach(t=>{const n=t();if(te.has(n))return;te.add(n);const r=n();if(typeof r=="function"&&H.push(r),D.has(n)){const o=D.get(n);o&&he(o,r)}if(G.has(n)){const o=G.get(n);o&&n.__propName&&Oe(n.__propName,o,r)}}),te.clear(),ee.clear(),x=!1}))}function Ge(e,t){D.set(e,t)}function He(e,t){G.set(e,t)}function We(e){G.delete(e);const t=e.__signals;if(t&&Array.isArray(t)){for(const n of t)n.removeDep(e);e.__signals=null}}function je(e){D.delete(e);const t=e.__signals;if(t&&Array.isArray(t)){for(const n of t)n.removeDep(e);e.__signals=null}}function Ue(e,t){ne=t;const n=document.createDocumentFragment();re=n;const r={type:"div",props:{children:[e]},dom:n};e.parent=r,_.push(e),requestIdleCallback(pe)}function Xe(){if(re&&ne){ne.appendChild(re);const e=performance.now();console.log(`Render time: ${e-O}ms`)}}let _=[],ne=null,re=null,O=-1;function pe(e){O===-1&&(O=performance.now());let t=!1;for(;_.length>0&&!t;){const n=_.pop();ze(n),t=e.timeRemaining()<1}if(_.length==0){Xe();return}requestIdleCallback(pe)}function ze(e){var t;if(e.type==="FRAGMENT"){const n=!e.props.children[S];let r=!1;for(let o=e.props.children.length-1;o>=0;o--)e.props.children[o].parent=e,n&&e.props.children[o].props.key===void 0&&e.renderFunction&&(r=!0),_.push(e.props.children[o]);r&&console.error("Array children must have a key attribute")}else if(typeof e.type=="function"){ce(e);const n=e.type(e.props);if(ae(),Array.isArray(n)){for(let r=n.length-1;r>=0;r--)n[r].parent=e,_.push(n[r]);e.props.children=n}else n.parent=e,e.props.children.push(n),_.push(n)}else{e.dom||(e.dom=de(e));let n=e.parent;for(;n&&!n.dom;)n=n.parent;n&&((t=n.dom)==null||t.appendChild(e.dom));for(let r=e.props.children.length-1;r>=0;r--)e.props.children[r].parent=e,_.push(e.props.children[r])}j(e)}function T(e){if(e.type==="FRAGMENT")if(e.props.children[S])for(const n of e.props.children)n.parent=e,T(n);else{let n=!1;for(const r of e.props.children)r.parent=e,r.props.key===void 0&&(n=!0),T(r);n&&console.error("Array children must have a key attribute")}else if(typeof e.type!="function")for(const t of e.props.children)t.parent=e,T(t);j(e)}function g(e,t,n,r,o){if(e.type==="FRAGMENT")for(const i of e.props.children)r&&(i.parent=e),g(i,t,n,r,o);else if(typeof e.type=="function"){ce(e);const i=e.type(e.props);if(ae(),Array.isArray(i)){for(const s of i)s.parent=e,g(s,t,n,!0,o);e.props.children=i}else i.parent=e,e.props.children.push(i),g(i,t,n,!0,o)}else{e.dom||(e.dom=de(e));let i;if(o)i=o;else{let s=e.parent;for(;s&&!s.dom;)s=s.parent;i=s==null?void 0:s.dom}t?n?i==null||i.replaceChild(e.dom,t):i==null||i.insertBefore(e.dom,t):i==null||i.appendChild(e.dom);for(const s of e.props.children)r&&(s.parent=e),g(s,void 0,void 0,r,e.dom)}r&&j(e)}let W=!0;function E(e,t){if(!(!e||!W)){if(e.renderFunction&&(t&&je(e.renderFunction),delete e.renderFunction),e.dom){for(const n of Object.keys(e.props))if(z(n)){const r=n.toLowerCase().substring(2);e.dom.removeEventListener(r,e.props[n]),delete e.props[n]}else typeof e.props[n]=="function"?We(e.props[n]):n==="ref"&&e.props[n]instanceof V&&(e.props[n].current=null);e.dom.remove()}typeof e.type=="function"&&(Fe(e,e.props),delete e.type),e.props.children.forEach(n=>E(n,!0))}}function j(e){e.renderFunction&&Ge(e.renderFunction,e)}function he(e,t){if(O=performance.now(),k(t)){const r={...b(t),parent:e.parent};T(r),F(e,r)}else if(Array.isArray(t)){const o={type:"FRAGMENT",props:{children:t[S]?t:R(t)},parent:e.parent};T(o),F(e,o)}else{const r={...t,parent:e.parent};T(r),F(e,r)}const n=performance.now();console.log("Update Time:",(n-O).toFixed(2),"ms")}function U(e,t){e.renderFunction&&(t.renderFunction=e.renderFunction,j(t))}function X(e,t,n){var r;if(n!==void 0){e.parent.props.children[n]=t;return}(r=e.parent)==null||r.props.children.forEach((o,i)=>{o===e&&(e.parent.props.children[i]=t)})}const z=e=>e.startsWith("on"),ye=e=>e!=="children"&&!z(e)&&e!=="key"&&e!=="ref",oe=(e,t,n)=>e[n]!==t[n],Ke=(e,t,n)=>!(n in t);function ge(e,t){var n,r;return e===t?!0:e.type!==t.type||((n=e.props)==null?void 0:n.key)!==((r=t.props)==null?void 0:r.key)?!1:I(e.props,t.props)}function I(e,t){if(e===t){if(e instanceof N&&t instanceof N)return I(e.value,t.value);if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let o=0;o<e.length;o++)if(!I(e[o],t[o]))return!1}return!0}if(k(e)&&k(t))return e===t;if(typeof e!=typeof t)return!1;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(let o of n)if(o!=="children"&&(!r.includes(o)||!I(e[o],t[o])))return!1;return!0}function me(e){if(e){if(e.dom)return e.dom;for(const t of e.props.children){const n=me(t);if(n)return n}}}function se(e){if(e){if(e.dom)return e.dom;for(let t=e.props.children.length-1;t>=0;t--){const n=e.props.children[t],r=se(n);if(r)return r}}}function $e(e){if(e)for(let t=e.props.children.length-1;t>=0;t--){const n=e.props.children[t],r=se(n);if(r)return r}}function qe(e){if(!e)return;let t=e.parent;for(;t&&!t.dom;)t=t.parent;return t}function Je(e){if(!e)return;if(e.dom)return e;let t=e.parent;for(;t&&!t.dom;)t=t.parent;return t}function F(e,t,n){if(!(!e&&!t)){if(e&&!t)E(e,!0),e.parent.props.children=e.parent.props.children.filter(r=>r!==e);else if(e&&t){const r=e.props,o=t.props;if(e.type==="FRAGMENT"||typeof e.type=="function")if(t.type==="FRAGMENT"||typeof t.type=="function")typeof e.type==typeof t.type&&typeof e.type=="function"?ge(e,t)||(g(t,me(e),void 0,!0),U(e,t),E(e),X(e,t,n)):we(e,t);else{t.parent=e.parent;let i=e.props.children[0];for(;i&&!i.dom;)i=i.props.children[0];g(t,i==null?void 0:i.dom),U(e,t),E(e),X(e,t,n)}else{const i=e.dom;if(e.type==="TEXT_CHILD"&&t.type==="TEXT_CHILD"&&!t.dom&&(t.dom=e.dom),i===void 0){console.error("no node found",e,t);return}if(t.type==="FRAGMENT"||typeof t.type=="function")t.parent=e.parent,U(e,t),g(t,i),E(e),X(e,t,n);else{for(const s of Object.keys(r))if(ye(s)&&Ke(r,o,s))i[s]="";else if(z(s)&&(!(s in o)||oe(r,o,s))){const l=s.toLowerCase().substring(2);i.removeEventListener(l,r[s])}if(e.type!==t.type)t.parent=e.parent,U(e,t),g(t,i,!0),E(e),X(e,t,n);else{for(const s of Object.keys(o))if(ye(s)&&oe(r,o,s))i[s]=o[s],r[s]=o[s];else if(z(s)&&oe(r,o,s)){const l=s.toLowerCase().substring(2);i.addEventListener(l,o[s]),r[s]=o[s]}we(e,t)}}}}}}function Ye(e,t){var a,A;const n=e.props.children,r=t.props.children,o={};for(let f=0;f<n.length;f++){const u=n[f].props.key;if(u==null||o.hasOwnProperty(String(u)))return!1;o[String(u)]=n[f]}const i=(a=$e(e))==null?void 0:a.nextSibling,s=qe(e),l=document.createDocumentFragment();if(r.length===0){e.props.children.length=0,(s==null?void 0:s.dom)instanceof HTMLElement&&(s.dom.innerHTML="");return}const c=e.props.children.length;for(let f=0;f<r.length;f++){const u=r[f],K=u.props.key,L=String(K);if(o.hasOwnProperty(L)){const m=o[L];c>f?e.props.children[f]=m:e.props.children.push(m),delete o[L];const le=t.props.children[f];le&&(le.parent=e),F(m,le,f),M(e.props.children[f],l,i)}else c>f?e.props.children[f]=u:e.props.children.push(u),u.parent=e,g(u,i,!1,!1,l)}for(const f in o)if(o.hasOwnProperty(f)){const u=o[f];E(u,!0)}for(;e.props.children.length>t.props.children.length;)e.props.children.pop();(A=s==null?void 0:s.dom)==null||A.appendChild(l)}function M(e,t,n){if(e.dom){if(e.dom===t||e.dom===n)return;n?t.insertBefore(e.dom,n):t.appendChild(e.dom)}else for(const r of e.props.children)M(r,t,n)}function we(e,t){const n=t.type==="FRAGMENT"&&!t.props.children[S],r=e.type==="FRAGMENT"&&!e.props.children[S];n&&r?Ye(e,t)===!1&&Ee(e,t):Ee(e,t),t.type==="FRAGMENT"&&t.props.children[S]?e.props.children[S]=!0:e.props.children[S]=!1,e.type=t.type}function ie(e,t){var r;let n=Math.max(e.props.children.length,t.props.children.length);for(let o=0;o<n;o++){let i=e.props.children[o],s=t.props.children[o];if(s&&(s.parent=e),!i&&s)g(s,(r=se(e.props.children.at(-1)))==null?void 0:r.nextSibling),e.props.children.push(s);else if(!s&&i)E(i,!0),e.props.children.splice(o,1),n=e.props.children.length,o--;else{F(i,s,o);const l=Math.max(e.props.children.length,t.props.children.length);l<n&&(n=l,o--)}}}function Ee(e,t){let n=Math.max(e.props.children.length,t.props.children.length);const r={};let o=0;for(let l=0;l<e.props.children.length;l++){const c=e.props.children[l].props.key;if(c!=null){if(o++,r.hasOwnProperty(String(c))){console.warn("Found two children with the same key",c),console.warn("When two fibers are found having same key the whole children will default to manual updates, which can be slower than with key based reconciliation"),ie(e,t);return}r[String(c)]={fiber:e.props.children[l],index:l}}}o==0&&ie(e,t);const i={};for(let l=0;l<t.props.children.length;l++){const c=t.props.children[l].props.key;if(c==null)continue;const a=r[String(c)];if(a){if(i.hasOwnProperty(String(c))){console.warn("Found two children with the same key",c),console.warn("When two fibers are found having same key the whole children will default to manual updates, which can be slower than with key based reconciliation"),ie(e,t);return}i[String(c)]={fiber:a.fiber,newIndex:l,oldIndex:a.index}}}const s=Je(e);for(let l=0;l<n;l++){let c=e.props.children[l],a=t.props.children[l];const A=a!=null&&a.props.key?String(a.props.key):"",f=i.hasOwnProperty(A);let u=c!=null&&c.props.key?String(c.props.key):"";if(u&&A&&u===A){F(c,a,l),s!=null&&s.dom&&M(e.props.children[l],s.dom);continue}const K=i.hasOwnProperty(u)&&i[u].newIndex>l,L=i.hasOwnProperty(u)&&i[u].newIndex<l;if((K||L)&&(W=!1),a&&(a.parent=e),!c&&a)if(f){const{fiber:m}=i[A];e.props.children.push(m),F(m,a,l),s!=null&&s.dom&&M(e.props.children[l],s.dom)}else s!=null&&s.dom&&g(a,void 0,!1,!1,s.dom),e.props.children.push(a);else if(!a&&c)E(c,!0),e.props.children.splice(l,1),n=e.props.children.length,l--;else if(f){const{fiber:m}=i[A];E(c,!0),W=!0,e.props.children[l]=m,F(m,a,l),s!=null&&s.dom&&M(e.props.children[l],s.dom)}else if(K||L)s!=null&&s.dom&&g(a,void 0,!1,!1,s.dom),e.props.children[l]=a;else{F(c,a,l),s!=null&&s.dom&&M(e.props.children[l],s.dom);const m=Math.max(e.props.children.length,t.props.children.length);m<n&&(n=m,l--)}W=!0}}typeof process<"u"&&process.env.NODE_ENV==="test"&&(module.exports={createFiber:T,commitDeletion:E,commitFiber:g,updateFiber:he,deepCompareFibers:ge,deepEqual:I});function Ze(e){let t=null;const n=(r,o)=>{t?(r.value=!1,o.value=null):e().then(i=>{if(i.default){if(typeof i.default!="function")throw new Error("Lazy-loaded component must be a functional component");t=i.default,r.value=!1,o.value=null}else o.value=new Error("No default export found from lazy-loaded module")}).catch(i=>{o.value=i,r.value=!1})};return r=>{const o=C(!0),i=C(null);n(o,i);const s=l=>typeof l=="string"||l&&typeof l=="object"&&"props"in l&&"type"in l;if(r.fallback!==void 0&&!s(r.fallback))throw new Error("Invalid fallback: Expected a string or a valid JSX node.");if(r.errorFallback!==void 0&&!(typeof r.errorFallback=="function"||s(r.errorFallback)))throw new Error("Invalid errorFallback: Expected a string, a valid JSX node, or a function returning a JSX node.");return B("FRAGMENT",null,()=>o.value?r.fallback:i.value!==null?r.errorFallback?typeof r.errorFallback=="function"?r.errorFallback(i.value):r.errorFallback:"Unknown error occurred while lazy loading component, use errorFallback prop to override":t&&B(t,{...r}))}}p.cleanUp=Se,p.computed=Te,p.createEffect=Ae,p.createElement=B,p.createPromise=Me,p.createRef=Le,p.createSignal=C,p.lazy=Ze,p.render=Ue,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
